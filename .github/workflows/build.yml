name: Build and Release

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Install ps2exe
      shell: powershell
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        Install-Module -Name ps2exe -Force -Scope CurrentUser -AllowClobber

    - name: Compile PowerShell to EXE
      shell: powershell
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        cd HP.UpdateManager.Gui
        Write-Host "Starting compilation..."
        Import-Module ps2exe
        Invoke-PS2EXE -InputFile "HP.UpdateManager.ps1" -OutputFile "HPUpdateManager.exe" -noConsole -verbose
        if (-not (Test-Path "HPUpdateManager.exe")) { 
            Write-Error "EXE compilation failed! Output file not found."
            exit 1 
        }

    - name: Compile Inno Setup Installer
      shell: powershell
      run: |
        $iscc = Get-ChildItem -Path "C:\Program Files (x86)\Inno Setup *" -Filter "ISCC.exe" -Recurse | Select-Object -First 1 -ExpandProperty FullName
        if (-not $iscc) { throw "ISCC.exe not found!" }
        Write-Host "Using Inno Setup Compiler: $iscc"
        & $iscc HP.UpdateManager.Gui/installer.iss

    - name: Prepare Release Artifacts
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "dist"
        
        # Check and move Main EXE
        if (Test-Path "HP.UpdateManager.Gui/HPUpdateManager.exe") {
            Move-Item "HP.UpdateManager.Gui/HPUpdateManager.exe" "dist/"
        } else {
            Write-Warning "HPUpdateManager.exe not found!"
        }

        # Check and move Installer
        $installerPath = "HP.UpdateManager.Gui/Output/HPUpdateManagerInstaller.exe"
        if (Test-Path $installerPath) {
            Move-Item $installerPath "dist/"
        } else {
            Write-Warning "Installer not found at $installerPath"
            # Debug listing
            Get-ChildItem -Recurse "HP.UpdateManager.Gui"
        }

        # List dist contents
        Get-ChildItem "dist"

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: HP-Update-Manager-Build
        path: dist/*

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        files: dist/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
