name: Build and Release

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      shell: powershell
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        Install-Module -Name ps2exe -Force -Scope CurrentUser -AllowClobber
        choco install innosetup --no-progress

    - name: Compile PowerShell to EXE
      shell: powershell
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        Write-Host "Building version: $version"

        cd HP.UpdateManager.Gui
        
        # Compile Portable EXE
        $portableName = "CentralHPUpdater-$version-portable.exe"
        Invoke-PS2EXE -InputFile "HP.UpdateManager.ps1" -OutputFile $portableName -noConsole
        
        if (-not (Test-Path $portableName)) { 
            Write-Error "Portable EXE compilation failed!"
            exit 1 
        }

        # Create a copy for the installer source (renamed to simple name for Inno Setup)
        Copy-Item $portableName "CentralHPUpdater.exe"

    - name: Compile Inno Setup Installer
      shell: powershell
      run: |
        $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        if (-not (Test-Path $iscc)) {
            $iscc = Get-ChildItem -Path "C:\Program Files (x86)\Inno Setup *" -Filter "ISCC.exe" -Recurse | Select-Object -First 1 -ExpandProperty FullName
        }
        
        if (-not $iscc) { 
            Write-Warning "ISCC.exe not found. Skipping Installer compilation."
            return
        }
        
        $version = "${{ github.ref_name }}".TrimStart('v')
        
        # Define AppVersion constant for Inno Setup
        # We need to ensure the Output directory exists or is defined in ISS
        $args = @("/DAppVersion=$version", "HP.UpdateManager.Gui/installer.iss")
        & $iscc $args

    - name: Prepare Release Artifacts
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "dist"
        
        $version = "${{ github.ref_name }}".TrimStart('v')
        
        # Move Portable EXE
        $portableSrc = "HP.UpdateManager.Gui/CentralHPUpdater-$version-portable.exe"
        if (Test-Path $portableSrc) {
            Move-Item $portableSrc "dist/"
        }

        # Move Installer (if it exists)
        $installerSrc = "HP.UpdateManager.Gui/Output/CentralHPUpdaterInstaller.exe"
        if (Test-Path $installerSrc) {
            $installerDest = "dist/CentralHPUpdater-$version-Setup.exe"
            Move-Item $installerSrc $installerDest
        }

        Get-ChildItem "dist"

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
